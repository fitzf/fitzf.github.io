<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 4.2.1"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="mask-icon" href="/images/favicon/safari-pinned-tab.svg" color="#222"><meta name="msapplication-config" content="/images/favicon/browserconfig.xml"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5/css/all.min.css"><link rel="stylesheet" href="//cdn.jsdelivr.net/npm/pace-js@1/themes/blue/pace-theme-minimal.css"><script src="//cdn.jsdelivr.net/npm/pace-js@1/pace.min.js"></script><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:"zhangfei.men",root:"/",scheme:"Gemini",version:"7.8.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!0,show_result:!0,style:null},back2top:{enable:!0,sidebar:!0,scrollpercent:!0},bookmark:{enable:!0,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!0,pangu:!0,comments:{style:"tabs",active:"valine",storage:!0,lazyload:!1,nav:null,activeClass:"valine"},algolia:{hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},path:"search.xml"}</script><meta name="description" content="Canal的介绍Canal的历史由来在早期的时候，阿里巴巴公司因为杭州和美国两个地方的机房都部署了数据库实例，但因为跨机房同步数据的业务需求 ，便孕育而生出了Canal，主要是基于trigger(触发器)的方式获取增量变更。从 2010 年开始，阿里巴巴公司开始逐步尝试数据库日志解析，获取增量变更的数据进行同步，由此衍生出了增量订阅和消费业务。当前的 Canal 支持的数据源端MySQL版本包括（"><meta property="og:type" content="article"><meta property="og:title" content="基于Docker结合Canal实现MySQL实时增量数据传输"><meta property="og:url" content="http://zhangfei.men/posts/5844eaeb/index.html"><meta property="og:site_name" content="Zhangfei&#39;s Blog"><meta property="og:description" content="Canal的介绍Canal的历史由来在早期的时候，阿里巴巴公司因为杭州和美国两个地方的机房都部署了数据库实例，但因为跨机房同步数据的业务需求 ，便孕育而生出了Canal，主要是基于trigger(触发器)的方式获取增量变更。从 2010 年开始，阿里巴巴公司开始逐步尝试数据库日志解析，获取增量变更的数据进行同步，由此衍生出了增量订阅和消费业务。当前的 Canal 支持的数据源端MySQL版本包括（"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="http://zhangfei.men/images/pasted-193.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-194.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-195.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-196.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-197.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-198.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-199.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-200.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-201.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-202.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-203.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-204.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-205.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-206.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-207.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-208.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-209.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-210.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-211.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-212.png"><meta property="og:image" content="http://zhangfei.men/images/pasted-213.png"><meta property="article:published_time" content="2017-04-08T09:50:29.000Z"><meta property="article:modified_time" content="2020-07-28T01:08:16.457Z"><meta property="article:author" content="Zhang Fei"><meta property="article:tag" content="Docker"><meta property="article:tag" content="Java"><meta property="article:tag" content="MySQL"><meta property="article:tag" content="ElasticSearch"><meta property="article:tag" content="Canal"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://zhangfei.men/images/pasted-193.png"><link rel="canonical" href="http://zhangfei.men/posts/5844eaeb/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0,lang:"zh-CN"}</script><title>基于Docker结合Canal实现MySQL实时增量数据传输 | Zhangfei's Blog</title><script async src="https://www.googletagmanager.com/gtag/js?id=UA-104138524-1"></script><script>if(CONFIG.hostname===location.hostname){function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-104138524-1")}</script><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?adebe72cfd8e363da0f54dbd3032630d";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script>!function(t,o,e,i,n){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},e=o.createElement("script"),tag=o.getElementsByTagName("script")[0],e.async=1,e.src=("https:"==document.location.protocol?"https://":"http://")+"assets.growingio.com/2.1/gio.js",tag.parentNode.insertBefore(e,tag)}(window,document,"script",0,"gio"),gio("init","3-wJ4Vc1s0T2ob2EFT0ejNdA0SF6iG4LD5qSwm8uW6A",{}),gio("send")</script><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript><link rel="alternate" href="/atom.xml" title="Zhangfei's Blog" type="application/atom+xml"></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div><div class="site-meta"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span><h1 class="site-title">Zhangfei's Blog</h1><span class="logo-line-after"><i></i></span></a><p class="site-subtitle" itemprop="description">Quick notes</p></div><div class="site-nav-right"><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class="site-nav"><ul id="menu" class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i> 首页</a></li><li class="menu-item menu-item-设计模式"><a href="/design-pattern/" rel="section"><i class="fa fa-cubes fa-fw"></i> 设计模式</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i> 关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i> 归档</a></li><li class="menu-item menu-item-schedule"><a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i> 日程表</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i> 站点地图</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i> 公益 404</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="search-pop-overlay"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocapitalize="off" placeholder="搜索..." spellcheck="false" type="search" class="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"><div id="no-result"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div></div></div></div></header><div class="reading-progress-bar"></div><a role="button" class="book-mark-link book-mark-link-fixed"></a> <a href="https://github.com/zhangfei9734" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content post posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://zhangfei.men/posts/5844eaeb/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="https://avatars2.githubusercontent.com/u/16345433?s=40&v=4"><meta itemprop="name" content="Zhang Fei"><meta itemprop="description" content="胡编一通，乱写一气"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="Zhangfei's Blog"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 基于Docker结合Canal实现MySQL实时增量数据传输</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-calendar"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2017-04-08 17:50:29" itemprop="dateCreated datePublished" datetime="2017-04-08T17:50:29+08:00">2017-04-08</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-folder"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E6%9C%AA%E5%88%86%E7%B1%BB/" itemprop="url" rel="index"><span itemprop="name">未分类</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="far fa-comment"></i></span> <span class="post-meta-item-text">Valine：</span><a title="valine" href="/posts/5844eaeb/#valine-comments" itemprop="discussionUrl"><span class="post-comments-count valine-comment-count" data-xid="/posts/5844eaeb/" itemprop="commentCount"></span></a></span><br><span class="post-meta-item" title="本文字数"><span class="post-meta-item-icon"><i class="far fa-file-word"></i></span> <span class="post-meta-item-text">本文字数：</span> <span>24k</span></span><span class="post-meta-item" title="阅读时长"><span class="post-meta-item-icon"><i class="far fa-clock"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span>22 分钟</span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="Canal的介绍"><a href="#Canal的介绍" class="headerlink" title="Canal的介绍"></a>Canal的介绍</h2><h3 id="Canal的历史由来"><a href="#Canal的历史由来" class="headerlink" title="Canal的历史由来"></a>Canal的历史由来</h3><p>在早期的时候，阿里巴巴公司因为杭州和美国两个地方的机房都部署了数据库实例，但因为跨机房同步数据的业务需求 ，便孕育而生出了Canal，主要是基于<code>trigger(触发器)</code>的方式获取增量变更。从 2010 年开始，阿里巴巴公司开始逐步尝试数据库日志解析，获取增量变更的数据进行同步，由此衍生出了增量订阅和消费业务。<br>当前的 Canal 支持的数据源端MySQL版本包括（ 5.1.x , 5.5.x , 5.6.x , 5.7.x , 8.0.x）</p><h3 id="Canal的应用场景"><a href="#Canal的应用场景" class="headerlink" title="Canal的应用场景"></a>Canal的应用场景</h3><p>目前普遍基于日志增量订阅和消费的业务，主要包括</p><ul><li>基于数据库增量日志解析，提供增量数据订阅和消费</li><li>数据库镜像</li><li>数据库实时备份</li><li>索引构建和实时维护(拆分异构索引、倒排索引等)</li><li>业务 Cache 刷新</li><li>带业务逻辑的增量数据处理</li></ul><h2 id="Canal的工作原理"><a href="#Canal的工作原理" class="headerlink" title="Canal的工作原理"></a>Canal的工作原理</h2><p>在介绍Canal的原理之前，我们先来了解下MySQL主从复制的原理<br><strong>MySQL主从复制原理</strong></p><p><img data-src="/images/pasted-193.png" alt="upload successful"></p><ul><li>MySQL master 将数据变更的操作写入二进制日志<code>binary log</code>中， 其中记录的内容叫做二进制日志事件<code>binary log events</code>，可以通过<code>show binlog events</code>命令进行查看</li><li>MySQL slave 会将 master 的<code>binary log</code>中的<code>binary log events</code> 拷贝到它的中继日志<code>relay log</code></li><li>MySQL slave 重读并执行<code>relay log</code> 中的事件，将数据变更映射到它自己的数据库表中</li></ul><p>了解了MySQL的工作原理，我们可以大致猜想到Canal应该也是采用类似的逻辑去实现增量数据订阅的功能，那么接下来我们看看实际上Canal的工作原理是怎样的？<br><strong>Canal工作原理</strong></p><p><img data-src="/images/pasted-194.png" alt="upload successful"></p><ul><li>Canal 模拟 MySQL slave 的交互协议，伪装自己为 MySQL slave ，向MySQL master 发送dump 协议</li><li>MySQL master 收到 dump 请求，开始推送 <code>binary log</code> 给 slave (也就是 Canal )</li><li>Canal 解析 <code>binary log</code> 对象(数据为<code>byte</code>流)</li></ul><p>基于这样的原理与方式，便可以完成数据库增量日志的获取解析，提供增量数据订阅和消费，实现MySQL实时增量数据传输的功能。<br>既然Canal是这样的一个框架，又是纯Java语言编写而成，那么我们接下来就开始学习怎么使用它并把它用到我们的实际工作中。</p><h2 id="Canal的Docker环境准备"><a href="#Canal的Docker环境准备" class="headerlink" title="Canal的Docker环境准备"></a>Canal的Docker环境准备</h2><p>因为目前容器化技术的火热，本文通过使用Docker来快速搭建开发环境，而传统方式的环境搭建，在我们学会了Docker容器环境搭建后，也能自行依葫芦画瓢搭建成功。由于本篇主要讲解Canal，所以关于Docker的内容不会涉及太多，主要会介绍Docker的基本概念和命令使用。</p><h3 id="什么是Docker"><a href="#什么是Docker" class="headerlink" title="什么是Docker"></a>什么是Docker</h3><p>相信绝大多数人都使用过虚拟机VMware，在使用VMware进行环境搭建的时候，只需提供了一个普通的系统镜像并成功安装，剩下的软件环境与应用配置还是如我们在本机操作一样在虚拟机里也操作一遍，而且VMware占用宿主机的资源较多，容易造成宿主机卡顿，而且系统镜像本身也占用过多空间。<br>为了便于大家快速理解Docker，便与VMware做对比来做介绍，Docker 提供了一个开始，打包，运行APP的平台，把 APP （应用）和底层 Infrastructure（基础设施）隔离开来。Docker中最主要的两个概念就是镜像（类似VMware的系统镜像）与容器（类似VMware里安装的系统）<br><strong>什么是Image（镜像）</strong></p><ul><li>文件和meta data的集合（root filesystem）</li><li>分层的，并且每一层都可以添加改变删除文件，成为一个新的Image</li><li>不同的Image可以共享相同的layer</li><li>Image本身是read-only的</li></ul><p><img data-src="/images/pasted-195.png" alt="upload successful"></p><p><strong>什么是Container（容器）</strong></p><ul><li>通过Image创建（copy）</li><li>在Image layer 之上建立一个container layer（可读写）</li><li>类比面向对象：类和实例</li><li>Image负责app的存储和分发，Container负责运行app</li></ul><p><img data-src="/images/pasted-196.png" alt="upload successful"></p><h3 id="Docker的网络介绍"><a href="#Docker的网络介绍" class="headerlink" title="Docker的网络介绍"></a>Docker的网络介绍</h3><p>Docker的网络类型有三种：<br><strong>bridge：桥接网络</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">默认情况下启动的Docker容器，都是使用 bridge，Docker安装时创建的桥接网络，</span><br><span class="line">每次Docker容器重启时，会按照顺序获取对应的IP地址，</span><br><span class="line">这个就导致重启下，Docker的IP地址就变了</span><br></pre></td></tr></table></figure><p><strong>none：无指定网络</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">使用 --network&#x3D;none ，docker 容器就不会分配局域网的IP</span><br></pre></td></tr></table></figure><p><strong>host：主机网络</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">使用 --network&#x3D;host，此时，Docker 容器的网络会附属在主机上，两者是互通的。</span><br><span class="line">例如，在容器中运行一个Web服务，监听8080端口，则主机的8080端口就会自动映射到容器中。</span><br></pre></td></tr></table></figure><p><strong>创建自定义网络：（设置固定IP）</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create --subnet=172.18.0.0/16 mynetwork</span><br></pre></td></tr></table></figure><p>查看存在的网络类型<code>docker network ls</code></p><p><img data-src="/images/pasted-197.png" alt="upload successful"></p><h3 id="搭建Canal环境"><a href="#搭建Canal环境" class="headerlink" title="搭建Canal环境"></a>搭建Canal环境</h3><p>附上Docker的下载安装地址==&gt; <a href="https://www.docker.com/products/docker-desktop" target="_blank" rel="noopener">Docker Download</a><br>下载Canal镜像<code>docker pull canal/canal-server</code></p><p><img data-src="/images/pasted-198.png" alt="upload successful"></p><p>下载MySQL镜像<code>docker pull mysql</code>，下载过的则如下图</p><p><img data-src="/images/pasted-199.png" alt="upload successful"></p><p>查看已经下载好的镜像<code>docker images</code></p><p><img data-src="/images/pasted-200.png" alt="upload successful"></p><p>接下来通过镜像生成MySQL容器与canal-server容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">##生成mysql容器</span></span><br><span class="line">docker run -d --name mysql --net mynetwork --ip 172.18.0.6 -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root mysql</span><br><span class="line"><span class="comment">##生成canal-server容器</span></span><br><span class="line">docker run -d --name canal-server --net mynetwork --ip 172.18.0.4 -p 11111:11111 canal/canal-server</span><br><span class="line"><span class="comment">## 命令介绍</span></span><br><span class="line">--net mynetwork <span class="comment">#使用自定义网络</span></span><br><span class="line">--ip   <span class="comment">#指定分配ip</span></span><br></pre></td></tr></table></figure><p>查看docker中运行的容器<code>docker ps</code></p><p><img data-src="/images/pasted-201.png" alt="upload successful"></p><h3 id="MySQL的配置修改"><a href="#MySQL的配置修改" class="headerlink" title="MySQL的配置修改"></a>MySQL的配置修改</h3><p>以上只是初步准备好了基础的环境，但是怎么让Canal伪装成salve并正确获取MySQL中的binary log呢？<br>对于自建 MySQL , 需要先开启 Binlog 写入功能，配置 binlog-format 为 ROW 模式，通过修改mysql配置文件来开启bin_log，使用 <code>find / -name my.cnf</code> 查找my.cnf, 修改文件内容如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log-bin&#x3D;mysql-bin # 开启 binlog</span><br><span class="line">binlog-format&#x3D;ROW # 选择 ROW 模式</span><br><span class="line">server_id&#x3D;1 # 配置 MySQL replaction 需要定义，不要和 canal 的 slaveId 重复</span><br></pre></td></tr></table></figure><p>进入mysql容器<code>docker exec -it mysql bash</code><br>创建链接MySQL的账号<code>canal</code>并授予作为 MySQL slave 的权限, 如果已有账户可直接 GRANT</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -proot</span><br><span class="line"><span class="comment"># 创建账号</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">USER</span> canal <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'canal'</span>;</span><br><span class="line"><span class="comment"># 授予权限</span></span><br><span class="line"><span class="keyword">GRANT</span> <span class="keyword">SELECT</span>, <span class="keyword">REPLICATION</span> <span class="keyword">SLAVE</span>, <span class="keyword">REPLICATION</span> <span class="keyword">CLIENT</span> <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'canal'</span>@<span class="string">'%'</span>;</span><br><span class="line"><span class="comment">-- GRANT ALL PRIVILEGES ON *.* TO 'canal'@'%' ;</span></span><br><span class="line"><span class="comment"># 刷新并应用</span></span><br><span class="line"><span class="keyword">FLUSH</span> <span class="keyword">PRIVILEGES</span>;</span><br></pre></td></tr></table></figure><p>数据库重启后, 简单测试 my.cnf 配置是否生效</p><p><img data-src="/images/pasted-202.png" alt="upload successful"></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'log_bin'</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'log_bin'</span>;</span><br><span class="line"><span class="keyword">show</span> <span class="keyword">master</span> <span class="keyword">status</span>;</span><br></pre></td></tr></table></figure><h3 id="Canal-Server的配置修改"><a href="#Canal-Server的配置修改" class="headerlink" title="Canal Server的配置修改"></a>Canal Server的配置修改</h3><p>进入canal-server容器<code>docker exec -it canal-server bash</code><br>编辑canal-server的配置<code>vi canal-server/conf/example/instance.properties</code></p><p><img data-src="/images/pasted-203.png" alt="upload successful"></p><p>更多配置请参考==&gt;<a href="https://github.com/alibaba/canal/wiki/AdminGuide" target="_blank" rel="noopener">canal配置说明</a><br>重启canal-server容器<code>docker restart canal-server</code><br>进入容器查看启动日志</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it canal-server bash</span><br><span class="line">tail -100f canal-server/logs/example/example.log</span><br></pre></td></tr></table></figure><p><img data-src="/images/pasted-204.png" alt="upload successful"></p><p>至此，我们的环境工作准备完成！！！</p><h2 id="拉取数据并同步保存到ElasticSearch"><a href="#拉取数据并同步保存到ElasticSearch" class="headerlink" title="拉取数据并同步保存到ElasticSearch"></a>拉取数据并同步保存到ElasticSearch</h2><p>本文的ElasticSearch也是基于Docker环境搭建，所以读者可执行如下命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载对镜像</span></span><br><span class="line">docker pull elasticsearch:7.1.1</span><br><span class="line">docker pull mobz/elasticsearch-head:5-alpine</span><br><span class="line"><span class="comment"># 创建容器并运行</span></span><br><span class="line">docker run -d --name elasticsearch --net mynetwork --ip 172.18.0.2 -p 9200:9200 -p 9300:9300 -e <span class="string">"discovery.type=single-node"</span> elasticsearch:7.1.1</span><br><span class="line">docker run -d --name elasticsearch-head --net mynetwork --ip 172.18.0.5 -p 9100:9100 mobz/elasticsearch-head:5-alpine</span><br></pre></td></tr></table></figure><p>环境已经准备好了，现在就要开始我们的编码实战部分了，怎么通过应用程序去获取Canal解析后的binlog数据。首先我们基于Spring Boot搭建一个Canal Demo应用。结构如下图所示</p><p><img data-src="/images/pasted-205.png" alt="upload successful"></p><p><strong>Student.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.canal.study.pojo;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 普通的实体domain对象</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Data</span> 用户生产getter、setter方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> String id;</span><br><span class="line">  <span class="keyword">private</span> String name;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">  <span class="keyword">private</span> String sex;</span><br><span class="line">  <span class="keyword">private</span> String city;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CanalConfig.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.canal.study.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnectors;</span><br><span class="line"><span class="keyword">import</span> java.net.InetSocketAddress;</span><br><span class="line"><span class="keyword">import</span> org.apache.http.HttpHost;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置一些跟canal相关到配置与公共bean</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> haha</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CanalConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// @Value 获取 application.properties配置中端内容</span></span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;canal.server.ip&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> String canalIp;</span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;canal.server.port&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> Integer canalPort;</span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;canal.destination&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> String destination;</span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;elasticSearch.server.ip&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> String elasticSearchIp;</span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;elasticSearch.server.port&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> Integer elasticSearchPort;</span><br><span class="line">  <span class="meta">@Value</span>(<span class="string">"$&#123;zookeeper.server.ip&#125;"</span>)</span><br><span class="line">  <span class="keyword">private</span> String zkServerIp;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 获取简单canal-server连接</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CanalConnector <span class="title">canalSimpleConnector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CanalConnector canalConnector = CanalConnectors</span><br><span class="line">        .newSingleConnector(<span class="keyword">new</span> InetSocketAddress(canalIp, canalPort), destination, <span class="string">""</span>, <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">return</span> canalConnector;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 通过连接zookeeper获取canal-server连接</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> CanalConnector <span class="title">canalHaConnector</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    CanalConnector canalConnector = CanalConnectors</span><br><span class="line">        .newClusterConnector(zkServerIp, destination, <span class="string">""</span>, <span class="string">""</span>);</span><br><span class="line">    <span class="keyword">return</span> canalConnector;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * elasticsearch 7.x客户端</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RestHighLevelClient <span class="title">restHighLevelClient</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    RestHighLevelClient client = <span class="keyword">new</span> RestHighLevelClient(</span><br><span class="line">        RestClient.builder(<span class="keyword">new</span> HttpHost(elasticSearchIp, elasticSearchPort))</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> client;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CanalDataParser.java</strong><br>由于这个类的代码较多，文中则摘出其中比较重要的部分，其它部分代码可从github上获取</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 元祖类型的对象定义</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;A&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;B&gt;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">TwoTuple</span>&lt;<span class="title">A</span>, <span class="title">B</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> A eventType;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> B columnMap;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">TwoTuple</span><span class="params">(A a, B b)</span> </span>&#123;</span><br><span class="line">    eventType = a;</span><br><span class="line">    columnMap = b;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析canal中的message对象内容</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> entrys</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;TwoTuple&lt;EventType, Map&gt;&gt; printEntry(List&lt;Entry&gt; entrys) &#123;</span><br><span class="line">  List&lt;TwoTuple&lt;EventType, Map&gt;&gt; rows = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (Entry entry : entrys) &#123;</span><br><span class="line">    <span class="comment">// binlog event的事件事件</span></span><br><span class="line">    <span class="keyword">long</span> executeTime = entry.getHeader().getExecuteTime();</span><br><span class="line">    <span class="comment">// 当前应用获取到该binlog锁延迟的时间</span></span><br><span class="line">    <span class="keyword">long</span> delayTime = System.currentTimeMillis() - executeTime;</span><br><span class="line">    Date date = <span class="keyword">new</span> Date(entry.getHeader().getExecuteTime());</span><br><span class="line">    SimpleDateFormat simpleDateFormat = <span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">    <span class="comment">// 当前的entry（binary log event）的条目类型属于事务</span></span><br><span class="line">    <span class="keyword">if</span> (entry.getEntryType() == EntryType.TRANSACTIONBEGIN</span><br><span class="line">        || entry.getEntryType() == EntryType.TRANSACTIONEND) &#123;</span><br><span class="line">      <span class="keyword">if</span> (entry.getEntryType() == EntryType.TRANSACTIONBEGIN) &#123;</span><br><span class="line">        TransactionBegin begin = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          begin = TransactionBegin.parseFrom(entry.getStoreValue());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidProtocolBufferException e) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"parse event has an error , data:"</span> + entry.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 打印事务头信息，执行的线程id，事务耗时</span></span><br><span class="line">        logger.info(transaction_format,</span><br><span class="line">            <span class="keyword">new</span> Object[]&#123;entry.getHeader().getLogfileName(),</span><br><span class="line">                String.valueOf(entry.getHeader().getLogfileOffset()),</span><br><span class="line">                String.valueOf(entry.getHeader().getExecuteTime()),</span><br><span class="line">                simpleDateFormat.format(date),</span><br><span class="line">                entry.getHeader().getGtid(),</span><br><span class="line">                String.valueOf(delayTime)&#125;);</span><br><span class="line">        logger.info(<span class="string">" BEGIN ----&gt; Thread id: &#123;&#125;"</span>, begin.getThreadId());</span><br><span class="line">        printXAInfo(begin.getPropsList());</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (entry.getEntryType() == EntryType.TRANSACTIONEND) &#123;</span><br><span class="line">        TransactionEnd end = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          end = TransactionEnd.parseFrom(entry.getStoreValue());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidProtocolBufferException e) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"parse event has an error , data:"</span> + entry.toString(), e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 打印事务提交信息，事务id</span></span><br><span class="line">        logger.info(<span class="string">"----------------\n"</span>);</span><br><span class="line">        logger.info(<span class="string">" END ----&gt; transaction id: &#123;&#125;"</span>, end.getTransactionId());</span><br><span class="line">        printXAInfo(end.getPropsList());</span><br><span class="line">        logger.info(transaction_format,</span><br><span class="line">            <span class="keyword">new</span> Object[]&#123;entry.getHeader().getLogfileName(),</span><br><span class="line">                String.valueOf(entry.getHeader().getLogfileOffset()),</span><br><span class="line">                String.valueOf(entry.getHeader().getExecuteTime()), simpleDateFormat.format(date),</span><br><span class="line">                entry.getHeader().getGtid(), String.valueOf(delayTime)&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当前entry（binary log event）的条目类型属于原始数据</span></span><br><span class="line">    <span class="keyword">if</span> (entry.getEntryType() == EntryType.ROWDATA) &#123;</span><br><span class="line">      RowChange rowChage = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// 获取储存的内容</span></span><br><span class="line">        rowChage = RowChange.parseFrom(entry.getStoreValue());</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"parse event has an error , data:"</span> + entry.toString(), e);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 获取当前内容的事件类型</span></span><br><span class="line">      EventType eventType = rowChage.getEventType();</span><br><span class="line">      logger.info(row_format,</span><br><span class="line">          <span class="keyword">new</span> Object[]&#123;entry.getHeader().getLogfileName(),</span><br><span class="line">              String.valueOf(entry.getHeader().getLogfileOffset()),</span><br><span class="line">              entry.getHeader().getSchemaName(),</span><br><span class="line">              entry.getHeader().getTableName(), eventType,</span><br><span class="line">              String.valueOf(entry.getHeader().getExecuteTime()), simpleDateFormat.format(date),</span><br><span class="line">              entry.getHeader().getGtid(), String.valueOf(delayTime)&#125;);</span><br><span class="line">      <span class="comment">// 事件类型是query或数据定义语言DDL直接打印sql语句，跳出继续下一次循环</span></span><br><span class="line">      <span class="keyword">if</span> (eventType == EventType.QUERY || rowChage.getIsDdl()) &#123;</span><br><span class="line">        logger.info(<span class="string">" sql ----&gt; "</span> + rowChage.getSql() + SEP);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      printXAInfo(rowChage.getPropsList());</span><br><span class="line">      <span class="comment">// 循环当前内容条目的具体数据</span></span><br><span class="line">      <span class="keyword">for</span> (RowData rowData : rowChage.getRowDatasList()) &#123;</span><br><span class="line">        List&lt;CanalEntry.Column&gt; columns;</span><br><span class="line">        <span class="comment">// 事件类型是delete返回删除前的列内容，否则返回改变后列的内容</span></span><br><span class="line">        <span class="keyword">if</span> (eventType == CanalEntry.EventType.DELETE) &#123;</span><br><span class="line">          columns = rowData.getBeforeColumnsList();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          columns = rowData.getAfterColumnsList();</span><br><span class="line">        &#125;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">        <span class="comment">// 循环把列的name与value放入map中</span></span><br><span class="line">        <span class="keyword">for</span> (Column column : columns) &#123;</span><br><span class="line">          map.put(column.getName(), column.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        rows.add(<span class="keyword">new</span> TwoTuple&lt;&gt;(eventType, map));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> rows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ElasticUtils.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.canal.study.common;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.example.canal.study.pojo.Student;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.DocWriteRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.delete.DeleteRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.delete.DeleteResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.get.GetRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.get.GetResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.index.IndexResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.update.UpdateRequest;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.action.update.UpdateResponse;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RequestOptions;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.client.RestHighLevelClient;</span><br><span class="line"><span class="keyword">import</span> org.elasticsearch.common.xcontent.XContentType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * es的crud工具类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> haha</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ElasticUtils</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> RestHighLevelClient restHighLevelClient;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 新增</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> student</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> index   索引</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveEs</span><span class="params">(Student student, String index)</span> </span>&#123;</span><br><span class="line">    IndexRequest indexRequest = <span class="keyword">new</span> IndexRequest(index)</span><br><span class="line">        .id(student.getId())</span><br><span class="line">        .source(JSON.toJSONString(student), XContentType.JSON)</span><br><span class="line">        .opType(DocWriteRequest.OpType.CREATE);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      IndexResponse response = restHighLevelClient.index(indexRequest, RequestOptions.DEFAULT);</span><br><span class="line">      log.info(<span class="string">"保存数据至ElasticSearch成功：&#123;&#125;"</span>, response.getId());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      log.error(<span class="string">"保存数据至elasticSearch失败: &#123;&#125;"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 查看</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> index 索引</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> id    _id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getEs</span><span class="params">(String index, String id)</span> </span>&#123;</span><br><span class="line">    GetRequest getRequest = <span class="keyword">new</span> GetRequest(index, id);</span><br><span class="line">    GetResponse response = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      response = restHighLevelClient.get(getRequest, RequestOptions.DEFAULT);</span><br><span class="line">      Map&lt;String, Object&gt; fields = response.getSource();</span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : fields.entrySet()) &#123;</span><br><span class="line">        System.out.println(entry.getKey() + <span class="string">":"</span> + entry.getValue());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      log.error(<span class="string">"从elasticSearch获取数据失败: &#123;&#125;"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 更新</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> student</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> index   索引</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateEs</span><span class="params">(Student student, String index)</span> </span>&#123;</span><br><span class="line">    UpdateRequest updateRequest = <span class="keyword">new</span> UpdateRequest(index, student.getId());</span><br><span class="line">    updateRequest.doc(JSON.toJSONString(student), XContentType.JSON);</span><br><span class="line">    UpdateResponse response = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      response = restHighLevelClient.update(updateRequest, RequestOptions.DEFAULT);</span><br><span class="line">      log.info(<span class="string">"更新数据至ElasticSearch成功：&#123;&#125;"</span>, response.getId());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      log.error(<span class="string">"更新数据至elasticSearch失败: &#123;&#125;"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 根据id删除数据</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> index 索引</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> id    _id</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">DeleteEs</span><span class="params">(String index, String id)</span> </span>&#123;</span><br><span class="line">    DeleteRequest deleteRequest = <span class="keyword">new</span> DeleteRequest(index, id);</span><br><span class="line">    DeleteResponse response = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      response = restHighLevelClient.delete(deleteRequest, RequestOptions.DEFAULT);</span><br><span class="line">      log.info(<span class="string">"从elasticSearch删除数据成功：&#123;&#125;"</span>, response.getId());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      log.error(<span class="string">"从elasticSearch删除数据失败: &#123;&#125;"</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>BinLogElasticSearch.java</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.canal.study.action;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.client.CanalConnector;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.CanalEntry;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.otter.canal.protocol.Message;</span><br><span class="line"><span class="keyword">import</span> com.example.canal.study.common.CanalDataParser;</span><br><span class="line"><span class="keyword">import</span> com.example.canal.study.common.ElasticUtils;</span><br><span class="line"><span class="keyword">import</span> com.example.canal.study.pojo.Student;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取binlog数据并发送到es中</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> haha</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BinLogElasticSearch</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> CanalConnector canalSimpleConnector;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> ElasticUtils elasticUtils;</span><br><span class="line">  <span class="comment">//@Qualifier("canalHaConnector")使用名为canalHaConnector的bean</span></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="meta">@Qualifier</span>(<span class="string">"canalHaConnector"</span>)</span><br><span class="line">  <span class="keyword">private</span> CanalConnector canalHaConnector;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">binLogToElasticSearch</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    openCanalConnector(canalSimpleConnector);</span><br><span class="line">    <span class="comment">// 轮询拉取数据</span></span><br><span class="line">    Integer batchSize = <span class="number">5</span> * <span class="number">1024</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"><span class="comment">//            Message message = canalHaConnector.getWithoutAck(batchSize);</span></span><br><span class="line">      Message message = canalSimpleConnector.getWithoutAck(batchSize);</span><br><span class="line">      <span class="keyword">long</span> id = message.getId();</span><br><span class="line">      <span class="keyword">int</span> size = message.getEntries().size();</span><br><span class="line">      log.info(<span class="string">"当前监控到binLog消息数量&#123;&#125;"</span>, size);</span><br><span class="line">      <span class="keyword">if</span> (id == -<span class="number">1</span> || size == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// 等待4秒</span></span><br><span class="line">          Thread.sleep(<span class="number">4000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//1. 解析message对象</span></span><br><span class="line">        List&lt;CanalEntry.Entry&gt; entries = message.getEntries();</span><br><span class="line">        List&lt;CanalDataParser.TwoTuple&lt;CanalEntry.EventType, Map&gt;&gt; rows = CanalDataParser</span><br><span class="line">            .printEntry(entries);</span><br><span class="line">        <span class="keyword">for</span> (CanalDataParser.TwoTuple&lt;CanalEntry.EventType, Map&gt; tuple : rows) &#123;</span><br><span class="line">          <span class="keyword">if</span> (tuple.eventType == CanalEntry.EventType.INSERT) &#123;</span><br><span class="line">            Student student = createStudent(tuple);</span><br><span class="line">            <span class="comment">// 2。将解析出的对象同步到elasticSearch中</span></span><br><span class="line">            elasticUtils.saveEs(student, <span class="string">"student_index"</span>);</span><br><span class="line">            <span class="comment">// 3.消息确认已处理</span></span><br><span class="line">            canalSimpleConnector.ack(id);</span><br><span class="line"><span class="comment">//                        canalHaConnector.ack(id);</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (tuple.eventType == CanalEntry.EventType.UPDATE) &#123;</span><br><span class="line">            Student student = createStudent(tuple);</span><br><span class="line">            elasticUtils.updateEs(student, <span class="string">"student_index"</span>);</span><br><span class="line">            <span class="comment">// 3.消息确认已处理</span></span><br><span class="line">            canalSimpleConnector.ack(id);</span><br><span class="line"><span class="comment">//                        canalHaConnector.ack(id);</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (tuple.eventType == CanalEntry.EventType.DELETE) &#123;</span><br><span class="line">            elasticUtils.DeleteEs(<span class="string">"student_index"</span>, tuple.columnMap.get(<span class="string">"id"</span>).toString());</span><br><span class="line">            canalSimpleConnector.ack(id);</span><br><span class="line"><span class="comment">//                        canalHaConnector.ack(id);</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 封装数据至Student对象中</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> tuple</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> Student <span class="title">createStudent</span><span class="params">(CanalDataParser.TwoTuple&lt;CanalEntry.EventType, Map&gt; tuple)</span> </span>&#123;</span><br><span class="line">    Student student = <span class="keyword">new</span> Student();</span><br><span class="line">    student.setId(tuple.columnMap.get(<span class="string">"id"</span>).toString());</span><br><span class="line">    student.setAge(Integer.parseInt(tuple.columnMap.get(<span class="string">"age"</span>).toString()));</span><br><span class="line">    student.setName(tuple.columnMap.get(<span class="string">"name"</span>).toString());</span><br><span class="line">    student.setSex(tuple.columnMap.get(<span class="string">"sex"</span>).toString());</span><br><span class="line">    student.setCity(tuple.columnMap.get(<span class="string">"city"</span>).toString());</span><br><span class="line">    <span class="keyword">return</span> student;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 打开canal连接</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> canalConnector</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">openCanalConnector</span><span class="params">(CanalConnector canalConnector)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//连接CanalServer</span></span><br><span class="line">    canalConnector.connect();</span><br><span class="line">    <span class="comment">// 订阅destination</span></span><br><span class="line">    canalConnector.subscribe();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 关闭canal连接</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> canalConnector</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">closeCanalConnector</span><span class="params">(CanalConnector canalConnector)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//关闭连接CanalServer</span></span><br><span class="line">    canalConnector.disconnect();</span><br><span class="line">    <span class="comment">// 注销订阅destination</span></span><br><span class="line">    canalConnector.unsubscribe();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>CanalDemoApplication.java（Spring Boot 启动类）</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.canal.study;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.example.canal.study.action.BinLogElasticSearch;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationArguments;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.ApplicationRunner;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 应用的启动类</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> haha</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CanalDemoApplication</span> <span class="keyword">implements</span> <span class="title">ApplicationRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">private</span> BinLogElasticSearch binLogElasticSearch;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    SpringApplication.run(CanalDemoApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 程序启动则执行run方法</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    binLogElasticSearch.binLogToElasticSearch();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>application.properties</strong></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">server.port&#x3D;8081</span><br><span class="line">spring.application.name &#x3D; canal-demo</span><br><span class="line">canal.server.ip &#x3D; localhost</span><br><span class="line">canal.server.port &#x3D; 11111</span><br><span class="line">canal.destination &#x3D; example</span><br><span class="line">zookeeper.server.ip &#x3D; localhost:2181</span><br><span class="line">zookeeper.sasl.client &#x3D; false</span><br><span class="line">elasticSearch.server.ip &#x3D; localhost</span><br><span class="line">elasticSearch.server.port &#x3D; 9200</span><br></pre></td></tr></table></figure><h2 id="Canal集群高可用的搭建"><a href="#Canal集群高可用的搭建" class="headerlink" title="Canal集群高可用的搭建"></a>Canal集群高可用的搭建</h2><p>通过上面的学习，我们知道了单机直连方式的Canal应用。在当今互联网时代，单实例模式逐渐被集群高可用模式取代，那么Canal的多实例集群方式如何搭建呢！</p><h3 id="基于Zookeeper获取Canal实例"><a href="#基于Zookeeper获取Canal实例" class="headerlink" title="基于Zookeeper获取Canal实例"></a>基于Zookeeper获取Canal实例</h3><p>准备Zookeeper的Docker镜像与容器</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull zookeeper</span><br><span class="line">docker run -d --name zookeeper --net mynetwork --ip 172.18.0.3 -p 2181:2181 zookeeper</span><br><span class="line">docker run -d --name canal-server2 --net mynetwork --ip 172.18.0.8 -p 11113:11113 canal/canal-server</span><br></pre></td></tr></table></figure><p>最终效果如图</p><p><img data-src="/images/pasted-206.png" alt="upload successful"></p><ol><li>机器准备<ul><li>运行Canal的容器ip： 172.18.0.4 , 172.18.0.8</li><li>Zookeeper容器ip：172.18.0.3:2181</li><li>MySQL容器ip：172.18.0.6:3306</li></ul></li><li>按照部署和配置，在单台机器上各自完成配置，演示时instance name为example</li><li>修改canal.properties，加上Zookeeper配置并修改Canal端口</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">canal.port&#x3D;11113</span><br><span class="line">canal.zkServers&#x3D;172.18.0.3:2181</span><br><span class="line">canal.instance.global.spring.xml &#x3D; classpath:spring&#x2F;default-instance.xml</span><br></pre></td></tr></table></figure><ol start="4"><li>创建example目录，并修改instance.properties</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.mysql.slaveId &#x3D; 1235</span><br><span class="line">#之前的canal slaveId是1234，保证slaveId不重复即可</span><br><span class="line">canal.instance.master.address &#x3D; 172.18.0.6:3306</span><br></pre></td></tr></table></figure><p><strong>注意：</strong> 两台机器上的instance目录的名字需要保证完全一致，HA模式是依赖于instance name进行管理，同时必须都选择default-instance.xml配置<br>启动两个不同容器的Canal，启动后，可以通过<code>tail -100f logs/example/example.log</code>查看启动日志，只会看到一台机器上出现了启动成功的日志。<br>比如我这里启动成功的是 172.18.0.4</p><p><img data-src="/images/pasted-207.png" alt="upload successful"></p><p>查看一下Zookeeper中的节点信息，也可以知道当前工作的节点为172.18.0.4:11111</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 15] get &#x2F;otter&#x2F;canal&#x2F;destinations&#x2F;example&#x2F;running  </span><br><span class="line">&#123;&quot;active&quot;:true,&quot;address&quot;:&quot;172.18.0.4:11111&quot;,&quot;cid&quot;:1&#125;</span><br></pre></td></tr></table></figure><h3 id="客户端链接-消费数据"><a href="#客户端链接-消费数据" class="headerlink" title="客户端链接, 消费数据"></a>客户端链接, 消费数据</h3><p>可以通过指定Zookeeper地址和Canal的instance name，canal client会自动从Zookeeper中的running节点，获取当前服务的工作节点，然后与其建立链接：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 0] get &#x2F;otter&#x2F;canal&#x2F;destinations&#x2F;example&#x2F;running</span><br><span class="line">&#123;&quot;active&quot;:true,&quot;address&quot;:&quot;172.18.0.4:11111&quot;,&quot;cid&quot;:1&#125;</span><br></pre></td></tr></table></figure><p>对应的客户端编码可以使用如下形式，上文中的<code>CanalConfig.java</code>中的<code>canalHaConnector</code>就是一个HA连接</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CanalConnector connector = CanalConnectors.newClusterConnector(<span class="string">"172.18.0.3:2181"</span>, <span class="string">"example"</span>, <span class="string">""</span>, <span class="string">""</span>);</span><br></pre></td></tr></table></figure><p>链接成功后，canal server会记录当前正在工作的canal client信息，比如客户端ip，链接的端口信息等 (聪明的你，应该也可以发现，canal client也可以支持HA功能)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 4] get &#x2F;otter&#x2F;canal&#x2F;destinations&#x2F;example&#x2F;1001&#x2F;running</span><br><span class="line">&#123;&quot;active&quot;:true,&quot;address&quot;:&quot;192.168.124.5:59887&quot;,&quot;clientId&quot;:1001&#125;</span><br></pre></td></tr></table></figure><p>数据消费成功后，canal server会在zookeeper中记录下当前最后一次消费成功的binlog位点. (下次你重启client时，会从这最后一个位点继续进行消费)</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 5] get &#x2F;otter&#x2F;canal&#x2F;destinations&#x2F;example&#x2F;1001&#x2F;cursor</span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.alibaba.otter.canal.protocol.position.LogPosition&quot;,&quot;identity&quot;:&#123;&quot;slaveId&quot;:-1,&quot;sourceAddress&quot;:&#123;&quot;address&quot;:&quot;mysql.mynetwork&quot;,&quot;port&quot;:3306&#125;&#125;,&quot;postion&quot;:&#123;&quot;included&quot;:false,&quot;journalName&quot;:&quot;binlog.000004&quot;,&quot;position&quot;:2169,&quot;timestamp&quot;:1562672817000&#125;&#125;</span><br></pre></td></tr></table></figure><p>停止正在工作的172.18.0.4的canal server</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it canal-server bash</span><br><span class="line"><span class="built_in">cd</span> canal-server/bin</span><br><span class="line">sh stop.sh</span><br></pre></td></tr></table></figure><p>这时172.18.0.8会立马启动example instance，提供新的数据服务</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[zk: localhost:2181(CONNECTED) 19] get &#x2F;otter&#x2F;canal&#x2F;destinations&#x2F;example&#x2F;running</span><br><span class="line">&#123;&quot;active&quot;:true,&quot;address&quot;:&quot;172.18.0.8:11111&quot;,&quot;cid&quot;:1&#125;</span><br></pre></td></tr></table></figure><p>与此同时，客户端也会随着canal server的切换，通过获取zookeeper中的最新地址，与新的canal server建立链接，继续消费数据，整个过程自动完成</p><h2 id="异常与总结"><a href="#异常与总结" class="headerlink" title="异常与总结"></a>异常与总结</h2><h3 id="elasticsearch-head无法访问elasticsearch"><a href="#elasticsearch-head无法访问elasticsearch" class="headerlink" title="elasticsearch-head无法访问elasticsearch"></a>elasticsearch-head无法访问elasticsearch</h3><p>es与es-head是两个独立的进程，当es-head访问es服务时，会存在一个跨域问题。所以我们需要修改es的配置文件，增加一些配置项来解决这个问题，如下</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost &#x2F;usr&#x2F;local&#x2F;elasticsearch-head-master]# cd ..&#x2F;elasticsearch-5.5.2&#x2F;config&#x2F;</span><br><span class="line">[root@localhost &#x2F;usr&#x2F;local&#x2F;elasticsearch-5.5.2&#x2F;config]# vim elasticsearch.yml  </span><br><span class="line"># 文件末尾加上如下配置</span><br><span class="line">http.cors.enabled: true</span><br><span class="line">http.cors.allow-origin: &quot;*&quot;</span><br></pre></td></tr></table></figure><p>修改完配置文件后需重启es服务</p><h3 id="elasticsearch-head查询报406-Not-Acceptable"><a href="#elasticsearch-head查询报406-Not-Acceptable" class="headerlink" title="elasticsearch-head查询报406 Not Acceptable"></a>elasticsearch-head查询报406 Not Acceptable</h3><p><img data-src="/images/pasted-208.png" alt="upload successful"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">解决方法:</span><br><span class="line">1、进入head安装目录；</span><br><span class="line">2、cd _site&#x2F;</span><br><span class="line">3、编辑vendor.js  共有两处</span><br><span class="line">     #6886行   contentType: &quot;application&#x2F;x-www-form-urlencoded</span><br><span class="line">    改成 contentType: &quot;application&#x2F;json;charset&#x3D;UTF-8&quot;</span><br><span class="line">     #7574行 var inspectData &#x3D; s.contentType &#x3D;&#x3D;&#x3D; &quot;application&#x2F;x-www-form-urlencoded&quot; &amp;&amp;</span><br><span class="line">    改成 var inspectData &#x3D; s.contentType &#x3D;&#x3D;&#x3D; &quot;application&#x2F;json;charset&#x3D;UTF-8&quot; &amp;&amp;</span><br></pre></td></tr></table></figure><h3 id="使用elasticsearch-rest-high-level-client报org-elasticsearch-action-index-IndexRequest-ifSeqNo"><a href="#使用elasticsearch-rest-high-level-client报org-elasticsearch-action-index-IndexRequest-ifSeqNo" class="headerlink" title="使用elasticsearch-rest-high-level-client报org.elasticsearch.action.index.IndexRequest.ifSeqNo"></a>使用elasticsearch-rest-high-level-client报org.elasticsearch.action.index.IndexRequest.ifSeqNo</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#pom中除了加入依赖</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch.client<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch-rest-high-level-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">#还需加入</span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.elasticsearch<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>elasticsearch<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>7.1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>相关参考 <a href="https://github.com/elastic/elasticsearch/issues/43023" target="_blank" rel="noopener">git hub issues</a></p><h3 id="为什么ElasticSearch要在7-X版本不能使用type"><a href="#为什么ElasticSearch要在7-X版本不能使用type" class="headerlink" title="为什么ElasticSearch要在7.X版本不能使用type?"></a>为什么ElasticSearch要在7.X版本不能使用type?</h3><p>参考：<a href="https://www.waitig.com/%E4%B8%BA%E4%BB%80%E4%B9%88elasticsearch%E8%A6%81%E5%9C%A87-x%E7%89%88%E6%9C%AC%E5%8E%BB%E6%8E%89type.html" target="_blank" rel="noopener">为什么ElasticSearch要在7.X版本去掉type?</a></p><h3 id="使用spring-data-elasticsearch-jar报org-elasticsearch-client-transport-NoNodeAvailableException"><a href="#使用spring-data-elasticsearch-jar报org-elasticsearch-client-transport-NoNodeAvailableException" class="headerlink" title="使用spring-data-elasticsearch.jar报org.elasticsearch.client.transport.NoNodeAvailableException"></a>使用spring-data-elasticsearch.jar报org.elasticsearch.client.transport.NoNodeAvailableException</h3><p>由于本文使用的是elasticsearch7.x以上的版本，目前spring-data-elasticsearch底层采用es官方TransportClient，而es官方计划放弃TransportClient，工具以es官方推荐的RestHighLevelClient进行调用请求。<br>可参考<a href="https://www.elastic.co/guide/en/elasticsearch/client/java-rest/current/java-rest-high-supported-apis.html" target="_blank" rel="noopener">RestHighLevelClient API</a></p><h3 id="设置docker容器开启启动"><a href="#设置docker容器开启启动" class="headerlink" title="设置docker容器开启启动"></a>设置docker容器开启启动</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果创建时未指定 --restart=always ,可通过update 命令</span></span><br><span class="line">docker update --restart=always [containerID]</span><br></pre></td></tr></table></figure><h3 id="Focker-for-Mac-network-host-模式不生效"><a href="#Focker-for-Mac-network-host-模式不生效" class="headerlink" title="Focker for Mac network host 模式不生效"></a>Focker for Mac network host 模式不生效</h3><p>host 模式是为了性能，但是这却对 docker 的隔离性造成了破坏，导致安全性降低。<br>在性能场景下，可以用 –netwokr host 开启 Host 模式，但需要注意的是，<strong>如果你用 Windows 或 Mac 本地启动容器的话，会遇到 host 模式失效的问题。原因是 host 模式只支持 Linux 宿主机。</strong><br>参见官方文档：<a href="https://docs.docker.com/network/host/" target="_blank" rel="noopener">docs.docker.com/network/hos…</a></p><h3 id="客户端连接Zookeeper报authenticate-using-SASL-unknow-error"><a href="#客户端连接Zookeeper报authenticate-using-SASL-unknow-error" class="headerlink" title="客户端连接Zookeeper报authenticate using SASL(unknow error)"></a>客户端连接Zookeeper报authenticate using SASL(unknow error)</h3><p><img data-src="/images/pasted-209.png" alt="upload successful"></p><ul><li>zookeeper.jar与dokcer中的zookeeper版本不一致</li><li>zookeeper.jar 使用了3.4.6之前的版本</li></ul><p>出现这个错的意思是zookeeper作为外部应用需要向系统申请资源，申请资源的时候需要通过认证，而sasl是一种认证方式，我们想办法来绕过sasl认证。避免等待，来提高效率。<br>在项目代码中加入<code>System.setProperty(&quot;zookeeper.sasl.client&quot;, &quot;false&quot;);</code>，如果是spring boot 项目可以在application.properties中加入<code>zookeeper.sasl.client=false</code><br>参考：<a href="https://issues.apache.org/jira/browse/ZOOKEEPER-1657" target="_blank" rel="noopener">Increased CPU usage by unnecessary SASL checks</a></p><h3 id="如果更换canal-client-jar中依赖的zookeeper-jar的版本"><a href="#如果更换canal-client-jar中依赖的zookeeper-jar的版本" class="headerlink" title="如果更换canal.client.jar中依赖的zookeeper.jar的版本"></a>如果更换canal.client.jar中依赖的zookeeper.jar的版本</h3><p>把canal的官方源码下载到本机<code>git clone https://github.com/alibaba/canal.git</code>，然后修改client模块下pom.xml文件中关于zookeeper的内容，然后重新<code>mvn install</code></p><p><img data-src="/images/pasted-210.png" alt="upload successful"></p><p>把自己项目依赖的包替换为刚刚<code>mvn install</code>生产的包</p><p><img data-src="/images/pasted-211.png" alt="upload successful"></p><h3 id="Zookeeper返回的是Docker容器中的IP，而宿主机IP与容器IP不是同一个网段，无法ping通"><a href="#Zookeeper返回的是Docker容器中的IP，而宿主机IP与容器IP不是同一个网段，无法ping通" class="headerlink" title="Zookeeper返回的是Docker容器中的IP，而宿主机IP与容器IP不是同一个网段，无法ping通"></a>Zookeeper返回的是Docker容器中的IP，而宿主机IP与容器IP不是同一个网段，无法ping通</h3><p>修改hosts文件只可以实现域名到ip的映射（域名重定向），iptables可以实现端口的重定向，但是这个问题是要通过ip到ip的重定向可以解决，但是研究了一下没找到怎么设置（windows、mac），所以我们修改canal的官方源码来达到我们想要的目的。修改<code>ClusterCanalConnector.java</code>中的<code>connect()</code>方法。<br>以下是修改后内容对比图</p><p><img data-src="/images/pasted-212.png" alt="upload successful"></p><h3 id="关于选型的取舍"><a href="#关于选型的取舍" class="headerlink" title="关于选型的取舍"></a>关于选型的取舍</h3><p><img data-src="/images/pasted-213.png" alt="upload successful"></p><p>本文示例项目源代码==&gt;<a href="https://github.com/jiangeeq/gitchat-code/tree/master/canal_demo" target="_blank" rel="noopener">canal-elasticsearch-sync</a></p><blockquote><p>作者：蒋老湿<br>链接：<a href="https://juejin.im/post/5d282f57e51d45590a445bcd" target="_blank" rel="noopener">https://juejin.im/post/5d282f57e51d45590a445bcd</a><br>来源：掘金</p></blockquote></div><div class="popular-posts-header">相关文章</div><ul class="popular-posts"><li class="popular-posts-item"><div class="popular-posts-title"><a href="/posts/18246ef3/" rel="bookmark">Docker Swarm 入门</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/posts/2a39a568/" rel="bookmark">Docker可视化管理工具Shipyard安装与配置</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/posts/b8062d72/" rel="bookmark">Docker的Secrets管理</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/posts/112e552d/" rel="bookmark">你应该知道的5个Docker实用工具</a></div></li><li class="popular-posts-item"><div class="popular-posts-title"><a href="/posts/4fa5d2db/" rel="bookmark">四个Kubernetes集群管理工具</a></div></li></ul><div class="followme"><p>欢迎关注我的其它发布渠道</p><div class="social-list"><div class="social-item"><a target="_blank" class="social-link" href="https://t.me/Eason"><span class="icon"><i class="fab fa-telegram"></i></span> <span class="label">Telegram</span></a></div><div class="social-item"><a target="_blank" class="social-link" href="/atom.xml"><span class="icon"><i class="fa fa-rss"></i></span> <span class="label">RSS</span></a></div></div></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/Docker/" rel="tag"># Docker</a> <a href="/tags/Java/" rel="tag"># Java</a> <a href="/tags/MySQL/" rel="tag"># MySQL</a> <a href="/tags/ElasticSearch/" rel="tag"># ElasticSearch</a> <a href="/tags/Canal/" rel="tag"># Canal</a></div><div class="post-widgets"><div class="wp_rating"><div id="wpac-rating"></div></div></div><div class="post-nav"><div class="post-nav-item"><a href="/posts/73c8edbb/" rel="prev" title="EL表达式fn:endsWith函数的bug"><i class="fa fa-chevron-left"></i> EL表达式fn:endsWith函数的bug</a></div><div class="post-nav-item"> <a href="/posts/2340281/" rel="next" title="从地址栏输入URL到页面加载完成发生了什么？">从地址栏输入URL到页面加载完成发生了什么？<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div><div class="comments" id="valine-comments"></div><script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Canal的介绍"><span class="nav-number">1.</span> <span class="nav-text">Canal的介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Canal的历史由来"><span class="nav-number">1.1.</span> <span class="nav-text">Canal的历史由来</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Canal的应用场景"><span class="nav-number">1.2.</span> <span class="nav-text">Canal的应用场景</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Canal的工作原理"><span class="nav-number">2.</span> <span class="nav-text">Canal的工作原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Canal的Docker环境准备"><span class="nav-number">3.</span> <span class="nav-text">Canal的Docker环境准备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是Docker"><span class="nav-number">3.1.</span> <span class="nav-text">什么是Docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Docker的网络介绍"><span class="nav-number">3.2.</span> <span class="nav-text">Docker的网络介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#搭建Canal环境"><span class="nav-number">3.3.</span> <span class="nav-text">搭建Canal环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL的配置修改"><span class="nav-number">3.4.</span> <span class="nav-text">MySQL的配置修改</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Canal-Server的配置修改"><span class="nav-number">3.5.</span> <span class="nav-text">Canal Server的配置修改</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#拉取数据并同步保存到ElasticSearch"><span class="nav-number">4.</span> <span class="nav-text">拉取数据并同步保存到ElasticSearch</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Canal集群高可用的搭建"><span class="nav-number">5.</span> <span class="nav-text">Canal集群高可用的搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#基于Zookeeper获取Canal实例"><span class="nav-number">5.1.</span> <span class="nav-text">基于Zookeeper获取Canal实例</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端链接-消费数据"><span class="nav-number">5.2.</span> <span class="nav-text">客户端链接, 消费数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#异常与总结"><span class="nav-number">6.</span> <span class="nav-text">异常与总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#elasticsearch-head无法访问elasticsearch"><span class="nav-number">6.1.</span> <span class="nav-text">elasticsearch-head无法访问elasticsearch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#elasticsearch-head查询报406-Not-Acceptable"><span class="nav-number">6.2.</span> <span class="nav-text">elasticsearch-head查询报406 Not Acceptable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用elasticsearch-rest-high-level-client报org-elasticsearch-action-index-IndexRequest-ifSeqNo"><span class="nav-number">6.3.</span> <span class="nav-text">使用elasticsearch-rest-high-level-client报org.elasticsearch.action.index.IndexRequest.ifSeqNo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#为什么ElasticSearch要在7-X版本不能使用type"><span class="nav-number">6.4.</span> <span class="nav-text">为什么ElasticSearch要在7.X版本不能使用type?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用spring-data-elasticsearch-jar报org-elasticsearch-client-transport-NoNodeAvailableException"><span class="nav-number">6.5.</span> <span class="nav-text">使用spring-data-elasticsearch.jar报org.elasticsearch.client.transport.NoNodeAvailableException</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置docker容器开启启动"><span class="nav-number">6.6.</span> <span class="nav-text">设置docker容器开启启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Focker-for-Mac-network-host-模式不生效"><span class="nav-number">6.7.</span> <span class="nav-text">Focker for Mac network host 模式不生效</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#客户端连接Zookeeper报authenticate-using-SASL-unknow-error"><span class="nav-number">6.8.</span> <span class="nav-text">客户端连接Zookeeper报authenticate using SASL(unknow error)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如果更换canal-client-jar中依赖的zookeeper-jar的版本"><span class="nav-number">6.9.</span> <span class="nav-text">如果更换canal.client.jar中依赖的zookeeper.jar的版本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Zookeeper返回的是Docker容器中的IP，而宿主机IP与容器IP不是同一个网段，无法ping通"><span class="nav-number">6.10.</span> <span class="nav-text">Zookeeper返回的是Docker容器中的IP，而宿主机IP与容器IP不是同一个网段，无法ping通</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关于选型的取舍"><span class="nav-number">6.11.</span> <span class="nav-text">关于选型的取舍</span></a></li></ol></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="Zhang Fei" src="https://avatars2.githubusercontent.com/u/16345433?s=40&v=4"><p class="site-author-name" itemprop="name">Zhang Fei</p><div class="site-description" itemprop="description">胡编一通，乱写一气</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">16</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">42</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="sidebar-button motion-element"><a onclick="tidioChatApi.open()"><i class="fa fa-comment"></i> Chat</a></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/zhangfei9734" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhangfei9734" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:zhangfei.eason@gmail.com" title="E-Mail → mailto:zhangfei.eason@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i> E-Mail</a></span><span class="links-of-author-item"><a href="https://www.facebook.com/zhangfeicn" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;zhangfeicn" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i> FB Page</a></span><span class="links-of-author-item"><a href="https://stackoverflow.com/users/7614492/eason-zhang" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;7614492&#x2F;eason-zhang" rel="noopener" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i> StackOverflow</a></span></div></div><div class="back-to-top motion-element"><i class="fa fa-arrow-up"></i> <span>0%</span></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="copyright"> &copy; 2016 – <span itemprop="copyrightYear">2020</span><span class="with-love"><i class="fa fa-heart"></i></span> <span class="author" itemprop="copyrightHolder">Zhang Fei</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-chart-area"></i></span> <span title="站点总字数">222k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">3:22</span></div><div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动</div><div class="addthis_inline_share_toolbox"><script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5dbb98e1e900ca44" async="async"></script></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div><div style="display:none"><script src="//s95.cnzz.com/z_stat.php?id=1278303802&web_id=1278303802"></script></div></div></footer></div><script src="/lib/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script><script src="//cdn.jsdelivr.net/npm/pangu@4/dist/browser/pangu.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/bookmark.js"></script><script>!function(){var o,n,e=document.getElementsByTagName("link");if(0<e.length)for(i=0;i<e.length;i++)"canonical"==e[i].rel.toLowerCase()&&e[i].href&&(o=e[i].href);n=o?o.split(":")[0]:window.location.protocol.split(":")[0],o||(o=window.location.href),function(){var e=o,i=document.referrer;if(!/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi.test(e)){var t="https"===String(n).toLowerCase()?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";i?(t+="?r="+encodeURIComponent(document.referrer),e&&(t+="&l="+e)):e&&(t+="?l="+e),(new Image).src=t}}(window)}()</script><script>CONFIG.page.isPost&&(wpac_init=window.wpac_init||[],wpac_init.push({widget:"Rating",id:21709,el:"wpac-rating",color:"fc6423"}),function(){if(!("WIDGETPACK_LOADED"in window)){WIDGETPACK_LOADED=!0;var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//embed.widgetpack.com/widget.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t.nextSibling)}}())</script><script src="/js/local-search.js"></script><script src="//code.tidio.co/ce7gqx8qiu8j5bijv6g026uzwtznfabv.js"></script><script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script><script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'http://zhangfei.men/posts/5844eaeb/',]
      });
      });
  </script><script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '4lGJ1v9lzpF1QOO20kGGoKpB-gzGzoHsz',
      appKey     : 'TBNkObI72zlxA5z1ToT6xtu8',
      placeholder: "Just go go",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,debug:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"right",width:150,height:300},mobile:{show:!0},react:{opacity:.7},log:!1})</script></body></html>